<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Realtime Auction Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <style>
    body { font-family: sans-serif; background: #f5f5fa; color: #222; }
    .container { max-width: 400px; margin: 40px auto; background: #fff; border-radius: 10px; box-shadow: 0 4px 16px #0001; padding: 2em; }
    h2, h3 { text-align: center; }
    label { display: block; margin-top: 1em; }
    input, button { width: 100%; padding: 0.5em; margin-top: 0.5em; }
    button { background: #6c63ff; color: #fff; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .status { margin: 1em 0; text-align: center; }
    .paused { color: #ff9800; font-weight: bold; }
    .bidder { color: #388e3c; font-weight: bold; }
    .log { font-size: 0.9em; background: #f0f0f0; border-radius: 5px; padding: 0.5em; margin-top: 1em; max-height: 100px; overflow-y: auto; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Realtime Auction</h2>
    <div id="joinArea">
      <label>Room Code (share with friends):</label>
      <input id="roomInput" placeholder="e.g. test123" autocomplete="off" />
      <label>Your Team Name:</label>
      <input id="teamInput" placeholder="e.g. Mumbai Indians" autocomplete="off" />
      <button onclick="joinAuction()">Join Auction</button>
    </div>
    <div id="auctionArea" style="display:none;">
      <h3 id="playerName"></h3>
      <div>
        <div>Current Bid: <span id="currentBid"></span></div>
        <div>Current Bidder: <span id="currentBidder"></span></div>
      </div>
      <div class="status">
        Status: <span id="auctionStatus"></span>
      </div>
      <input id="bidInput" type="number" placeholder="Your bid" step="0.01" min="0" />
      <button onclick="placeBid()">Place Bid</button>
      <button onclick="pauseAuction()">Pause</button>
      <button onclick="resumeAuction()">Resume</button>
      <div class="log" id="logArea"></div>
    </div>
  </div>
  <script>
    // 1. Paste your Firebase config here
    const firebaseConfig = {
      apiKey: "AIzaSyA-nfEWO7BNx-XW4kRI5jqcEt-kVfxQ7T4",
      authDomain: "auctionsite-backend.firebaseapp.com",
      databaseURL: "https://auctionsite-backend-default-rtdb.firebaseio.com",
      projectId: "auctionsite-backend",
      storageBucket: "auctionsite-backend.appspot.com",
      messagingSenderId: "232850109661",
      appId: "1:232850109661:web:c2b7509b526ac925249734",
      measurementId: "G-199LFVLV3S"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let auctionRef = null;
    let auctionState = null;
    let auctionId = null;
    let myTeamId = null;
    let myTeamName = null;

    // 2. Join or create auction room
    function joinAuction() {
      auctionId = document.getElementById('roomInput').value.trim();
      myTeamName = document.getElementById('teamInput').value.trim();
      if (!auctionId || !myTeamName) {
        alert("Enter both room code and your team name!");
        return;
      }
      auctionRef = db.ref('auctions/' + auctionId);

      // Try to join an existing team or create a new one
      auctionRef.once('value', snap => {
        let state = snap.val();
        if (!state) {
          // Create new auction room
          myTeamId = 0;
          auctionRef.set({
            players: [
              { name: "Virat Kohli", position: "Batsman", basePrice: 2 }
            ],
            teams: [
              { id: 0, name: myTeamName, budget: 10, players: [] }
            ],
            currentPlayerIndex: 0,
            currentBid: 2,
            currentBidder: null,
            status: "running",
            logs: []
          });
        } else {
          // Check if team already exists
          let found = false;
          if (state.teams) {
            state.teams.forEach((team, idx) => {
              if (team.name.toLowerCase() === myTeamName.toLowerCase()) {
                myTeamId = team.id;
                found = true;
              }
            });
          }
          if (!found) {
            // Add new team
            myTeamId = (state.teams && state.teams.length) ? state.teams.length : 0;
            let newTeam = { id: myTeamId, name: myTeamName, budget: 10, players: [] };
            auctionRef.child('teams').transaction(teams => {
              if (!teams) teams = [];
              teams.push(newTeam);
              return teams;
            });
          }
        }
      });

      // Listen for changes
      auctionRef.on('value', snap => {
        auctionState = snap.val();
        if (auctionState) updateUI();
      });

      document.getElementById('joinArea').style.display = 'none';
      document.getElementById('auctionArea').style.display = '';
    }

    // 3. Update UI with auction state
    function updateUI() {
      const player = auctionState.players[auctionState.currentPlayerIndex];
      document.getElementById('playerName').textContent = player ? player.name : "No player";
      document.getElementById('currentBid').textContent = auctionState.currentBid;
      document.getElementById('currentBidder').textContent =
        auctionState.currentBidder !== null && auctionState.teams[auctionState.currentBidder]
          ? auctionState.teams[auctionState.currentBidder].name
          : "None";
      document.getElementById('auctionStatus').textContent = auctionState.status;
      document.getElementById('auctionStatus').className = auctionState.status === "paused" ? "paused" : "";
      document.getElementById('bidInput').disabled = (auctionState.status !== "running");

      // Show log
      let logHtml = "";
      if (auctionState.logs) {
        auctionState.logs.slice(-10).forEach(log => {
          logHtml += `<div>${log}</div>`;
        });
      }
      document.getElementById('logArea').innerHTML = logHtml;
    }

    // 4. Place a bid (only if auction running and you have enough budget)
    function placeBid() {
      const bid = parseFloat(document.getElementById('bidInput').value);
      if (isNaN(bid)) return alert("Enter a valid bid");
      auctionRef.transaction(state => {
        if (!state) return;
        if (state.status !== "running") return state;
        if (!state.teams || myTeamId === null) return state;
        const myTeam = state.teams[myTeamId];
        if (!myTeam) return state;
        if (bid > state.currentBid && myTeam.budget >= bid) {
          state.currentBid = bid;
          state.currentBidder = myTeamId;
          state.logs = state.logs || [];
          state.logs.push(`${myTeam.name} bid â‚¹${bid}`);
        }
        return state;
      });
      document.getElementById('bidInput').value = "";
    }

    // 5. Pause and resume
    function pauseAuction() {
      auctionRef.update({ status: "paused" });
    }
    function resumeAuction() {
      auctionRef.update({ status: "running" });
    }
  </script>
</body>
</html>
